<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minerva School ‚Äî Where curiosity finds its community</title>
  <meta name="theme-color" content="#7B3FE4" />
  <style>
    /* ==== BRAND PALETTE tuned to your lotus logo ==== */
    :root{
      /* Core brand */
      --violet-25:#FBF7FF;
      --violet-50:#F7F2FF;       /* page background */
      --violet-100:#EFE6FF;
      --violet-200:#E3D6FF;      /* requested light violet film */
      --violet-300:#C9B6FF;
      --violet-500:#8A3BEB;      /* button gradient start */
      --violet-600:#7B3FE4;      /* primary button / active */
      --magenta-500:#C94BD6;     /* accent (logo petal) */
      --teal-500:#2FA5A2;        /* secondary accent (logo leaf) */

      --ink:#0f172a;
      --muted:#475569;
      --surface:#ffffff;         /* solid surface */
      --card:#ffffffCC;          /* translucent card */
      --ring:#E5D7FF;            /* focus & borders tuned to brand */
      --shadow:0 10px 30px rgba(31, 41, 55, .12);
      --radius:14px;

      --gradient:linear-gradient(135deg, var(--violet-600), var(--magenta-500));
    }

    /* Dark mode (auto). Usable plus a simple toggle (below). */
    @media (prefers-color-scheme: dark) {
      :root{
        --violet-50:#0f0a1a;
        --surface:#0d0b13;
        --card:#151221DD;
        --ink:#e5e7eb;
        --muted:#94a3b8;
        --ring:#3b2b66;
        --shadow:0 10px 30px rgba(0,0,0,.5);
      }
      body { background: radial-gradient(1000px 600px at 10% -10%, #201537, transparent 60%), #0f0a1a; }
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background: var(--violet-50);
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.1) blur(8px);
      background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.72));
      border-bottom:1px solid var(--ring);
    }

    .nav{
      max-width:1120px; margin:auto; padding:10px 16px; display:flex; align-items:center; gap:16px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand img.logo{
      height:30px; width:auto; display:block;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
    }
    .brand .title{
      display:flex; flex-direction:column;
    }
    .brand .name{ font-weight:800; letter-spacing:.2px }
    .brand .tagline{ font-size:12px; color:var(--muted); margin-top:-2px }

    .nav a{color:var(--muted); text-decoration:none; padding:8px 10px; border-radius:10px}
    .nav a.active{background:var(--violet-100); color:var(--violet-600); font-weight:600}
    .spacer{flex:1}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--ring); background:var(--surface); color:var(--ink); cursor:pointer}
    .btn.primary{background:var(--gradient); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.switch{font-size:13px; padding:8px 10px}

    main{max-width:1120px; margin:0 auto; padding:22px 16px 64px}
    .abstract-bg{position:relative; isolation:isolate}
    .abstract-bg:before{
      content:""; position:absolute; inset:0; z-index:-1; opacity:.55;
      background:
        radial-gradient(700px 320px at 5% -10%, var(--violet-200), transparent 60%),
        radial-gradient(700px 320px at 95% -10%, #FFE6F9, transparent 60%),
        radial-gradient(700px 500px at 40% 110%, #E9FEFB, transparent 55%),
        conic-gradient(from 20deg at 60% 40%, #ffffff, #faf5ff, #fff, #faf5ff);
      filter: saturate(1.1);
    }

    .row{display:grid; grid-template-columns:1fr; gap:18px}
    @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}

    .card{background:var(--card); border:1px solid var(--ring); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    h1,h2,h3{margin:8px 0 12px}
    h1{font-size:28px}
    h2{font-size:22px}
    label{display:block; font-size:14px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--ring); background:var(--surface); color:var(--ink)}
    .fields{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:640px){.fields.two{grid-template-columns:1fr 1fr}}

    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--ring)}
    .table th, .table td{padding:12px 14px; text-align:left; background:var(--surface); color:var(--ink)}
    .table th{background: #f8f7ff; color:#4c1d95}
    .table tr + tr td{border-top:1px solid var(--ring)}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--ring); background:var(--surface); font-size:12px}
    .progress{height:10px; background:#eee; border-radius:999px; overflow:hidden}
    .progress>span{display:block; height:100%; background:linear-gradient(90deg, var(--violet-600), var(--magenta-500)); width:0}
    .grid{display:grid; grid-template-columns:repeat(1, minmax(0,1fr)); gap:16px}
    @media(min-width:700px){.grid{grid-template-columns:repeat(2, minmax(0,1fr))}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(3, minmax(0,1fr))}}

    .footer{max-width:1120px; margin:40px auto; color:var(--muted); text-align:center}

    .toast{position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; padding:12px 14px; border-radius:10px; opacity:0; transform:translateY(10px); transition:.25s; z-index:50}
    .toast.show{opacity:1; transform:none}

    /* chat */
    .chat{display:flex; gap:10px}
    .chat .list{flex:0 0 260px; display:grid; gap:10px}
    .chat .panel{flex:1; border:1px solid var(--ring); background:var(--surface); border-radius:12px; display:flex; flex-direction:column}
    .chat .messages{padding:10px; flex:1; overflow:auto; display:grid; gap:8px}
    .bubble{max-width:70%; padding:10px 12px; border-radius:12px; background:#f5f3ff;}
    .bubble.me{margin-left:auto; background:#ede9fe}
    .chat .composer{display:flex; gap:8px; padding:10px; border-top:1px solid var(--ring)}

    .hidden{display:none!important}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f5f3ff; padding:2px 6px; border-radius:6px; border:1px solid var(--ring)}
    .tag{font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#4338ca}

    /* simple animated focus ring for creativity */
    .btn:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
      outline:none; box-shadow:0 0 0 3px rgba(123,63,228,.25), 0 0 0 6px rgba(201,75,214,.20);
      transition: box-shadow .18s ease;
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav" aria-label="Primary">
      <!-- BRAND with actual image logo -->
      <div class="brand">
        <!-- Put logo.png next to this file -->
        <img class="logo" src="logo.png" alt="Minerva School logo" onerror="this.classList.add('hidden')">
        <!-- Fallback if image missing -->
        <div class="logo hidden" aria-hidden="true" style="
          width:28px; height:28px; border-radius:8px;
          background: radial-gradient(120px 80px at -10% 50%, var(--violet-300), transparent 60%),
                      radial-gradient(120px 80px at 110% 50%, #A78BFA, transparent 60%),
                      linear-gradient(135deg, #F3E8FF, #EDE9FE);
          border:1px solid var(--ring); box-shadow:var(--shadow);"></div>
        <div class="title">
          <div class="name">Minerva School</div>
          <div class="tagline">Where curiosity finds its community</div>
        </div>
        <span class="tag">Prototype</span>
      </div>

      <!-- FIXED: correct Join anchor (was "#joinJoin") -->
      <a href="#join" data-link>Join</a>
      <a href="#login" data-link>Log in</a>
      <a href="#lessons" data-link>Lessons</a>
      <a href="#peers" data-link>Peers</a>
      <a href="#projects" data-link>Projects</a>
      <a href="#dashboard" data-link>Dashboard</a>
      <span class="spacer"></span>

      <!-- Theme toggle -->
      <button class="btn switch" id="themeBtn" title="Toggle theme">Theme</button>

      <button id="logoutBtn" class="btn ghost hidden">Log out</button>
    </nav>
  </header>

  <main>
    <!-- JOIN -->
    <section id="join" class="abstract-bg" data-route>
      <div class="row">
        <div class="card">
          <h1>Join Minerva</h1>
          <p style="margin-top:-4px;color:var(--muted)">Where curiosity finds its community.</p>
          <form id="joinForm" autocomplete="on">
            <div class="fields two">
              <div>
                <label for="firstName">First name</label>
                <input id="firstName" name="firstName" required placeholder="e.g., Asha" />
              </div>
              <div>
                <label for="lastName">Last name</label>
                <input id="lastName" name="lastName" required placeholder="e.g., Kumar" />
              </div>
            </div>
            <div class="fields">
              <div>
                <label for="role">Role</label>
                <select id="role" name="role" required>
                  <option> Learner </option>
                  <option> Teacher </option>
                  <option> Mentor </option>
                  <option> Parent </option>
                  <option> Admin </option>
                </select>
              </div>
              <div>
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required placeholder="name@example.com" />
              </div>
              <div>
                <label for="pw">Password</label>
                <input type="password" id="pw" name="pw" minlength="6" required placeholder="Minimum 6 characters" />
              </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:12px">
              <button class="btn primary" type="submit">Create account</button>
              <a class="btn" href="#login" data-link>Already have an account? Log in</a>
            </div>
          </form>
        </div>

        <aside class="card">
          <h2>Why Minerva</h2>
          <ul>
            <li>Personalized pathways across K‚Äë12</li>
            <li>Mentor and peer support with guardrails</li>
            <li>Project‚Äëbased, purpose‚Äëdriven learning</li>
          </ul>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
            <span class="pill">Safe‚Äëby‚Äëdesign</span>
            <span class="pill">Evidence‚Äëinformed</span>
            <span class="pill">Community</span>
          </div>
        </aside>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="login" class="abstract-bg hidden" data-route>
      <div class="row">
        <div class="card" style="max-width:560px">
          <h1>Welcome back</h1>
          <p style="margin-top:-4px;color:var(--muted)">Sign in to continue to your dashboard.</p>
          <form id="loginForm">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" required placeholder="name@example.com" />
            <label for="loginPw">Password</label>
            <input id="loginPw" type="password" required />
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px">
              <label style="display:flex; align-items:center; gap:6px"><input type="checkbox" id="showPw"/> Show password</label>
              <button type="button" class="btn ghost" id="forgotBtn">Forgot password?</button>
            </div>
            <div style="margin-top:12px; display:flex; gap:10px">
              <button class="btn primary" type="submit">Log in</button>
              <a class="btn" href="#join" data-link>Create account</a>
            </div>
          </form>
        </div>
        <div class="card">
          <h2>New to Minerva?</h2>
          <p>Build your learning passport and join purpose‚Äëdriven projects.</p>
          <a class="btn" href="#join" data-link>Get started</a>
        </div>
      </div>
    </section>

    <!-- LESSONS -->
    <section id="lessons" class="abstract-bg hidden" data-route>
      <div class="card">
        <h1>Lessons</h1>
        <div class="fields two" style="margin:10px 0 4px">
          <div>
            <label for="gradeSelect">Grade</label>
            <select id="gradeSelect"></select>
          </div>
          <div>
            <label>Subjects</label>
            <div style="display:flex; flex-wrap:wrap; gap:8px">
              <label class="pill"><input type="checkbox" class="subFilter" value="Math" checked> Math</label>
              <label class="pill"><input type="checkbox" class="subFilter" value="Science" checked> Science</label>
              <label class="pill"><input type="checkbox" class="subFilter" value="English" checked> English</label>
              <label class="pill"><input type="checkbox" class="subFilter" value="Social Studies" checked> Social Studies</label>
              <label class="pill"><input type="checkbox" class="subFilter" value="Computer Science" checked> Computer Science</label>
              <label class="pill"><input type="checkbox" class="subFilter" value="Arts" checked> Arts</label>
              <label class="pill"><input type="checkbox" class="subFilter" value="PE" checked> PE</label>
              <label class="pill"><input type="checkbox" class="subFilter" value="Life Skills" checked> Life Skills</label>
            </div>
          </div>
        </div>
        <div class="card" style="padding:0">
          <table class="table" aria-describedby="lessonsHelp">
            <thead><tr>
              <th>Lesson</th><th>Subject</th><th>Mode</th><th>Grade band</th><th>Action</th>
            </tr></thead>
            <tbody id="lessonsBody"></tbody>
          </table>
        </div>
        <small id="lessonsHelp" style="color:var(--muted)">Tip: filter by Grade and Subjects. Click <span class="kbd">Open</span> to preview.</small>
      </div>
    </section>

    <!-- PEERS -->
    <section id="peers" class="abstract-bg hidden" data-route>
      <div class="card">
        <h1>Peers</h1>
        <p style="margin-top:-4px;color:var(--muted)">Find classmates and mentors for collaborative learning.</p>
        <div class="fields two">
          <div>
            <label>Interests</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <label class="pill"><input type="checkbox" class="interest" value="Climate"> Climate</label>
              <label class="pill"><input type="checkbox" class="interest" value="Robotics"> Robotics</label>
              <label class="pill"><input type="checkbox" class="interest" value="Art"> Art</label>
              <label class="pill"><input type="checkbox" class="interest" value="Debate"> Debate</label>
              <label class="pill"><input type="checkbox" class="interest" value="Sports"> Sports</label>
            </div>
          </div>
          <div>
            <label for="roleFilter">Role</label>
            <select id="roleFilter"><option value="All">All</option><option>Learner</option><option>Teacher</option><option>Mentor</option></select>
          </div>
        </div>
        <div class="chat" style="margin-top:12px">
          <div class="list" id="peerList"></div>
          <div class="panel">
            <div class="messages" id="chatMessages" aria-live="polite"></div>
            <div class="composer">
              <input id="chatInput" placeholder="Write a message to your peer‚Ä¶"/>
              <button class="btn primary" id="sendMsg">Send</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PROJECTS -->
    <section id="projects" class="abstract-bg hidden" data-route>
      <div class="card">
        <h1>Projects</h1>
        <p style="margin-top:-4px;color:var(--muted)">Showcase of purpose‚Äëdriven projects (curated + community).</p>
        <div class="fields two">
          <div>
            <label for="projTheme">Theme</label>
            <select id="projTheme">
              <option value="All">All</option>
              <option value="STEM">STEM</option>
              <option value="Arts & Culture">Arts & Culture</option>
              <option value="Media & Communication">Media & Communication</option>
              <option value="Community & Service">Community & Service</option>
              <option value="Entrepreneurship">Entrepreneurship</option>
              <option value="Wellbeing">Wellbeing</option>
            </select>
          </div>
          <div>
            <label for="projGrade">Grade band</label>
            <select id="projGrade">
              <option value="All">All</option>
              <option value="K-2">K‚Äì2</option>
              <option value="3-5">3‚Äì5</option>
              <option value="6-8">6‚Äì8</option>
              <option value="9-12">9‚Äì12</option>
            </select>
          </div>
        </div>
        <div class="grid" id="projectGrid" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="abstract-bg hidden" data-route>
      <div class="row">
        <div class="card">
          <h1>Dashboard</h1>
          <p style="margin-top:-4px;color:var(--muted)">Progress, reflections, and mentor feedback</p>
          <div class="fields two">
            <div>
              <h3>Learning progress</h3>
              <div style="display:grid; gap:10px" id="progressList"></div>
            </div>
            <div>
              <h3>Upcoming</h3>
              <ul id="upcomingList" style="margin-top:6px"></ul>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Reflections</h2>
          <div id="reflections"></div>
          <div class="fields" style="margin-top:8px">
            <textarea id="reflectInput" rows="3" placeholder="What did you learn today? What will you try next time?"></textarea>
            <div style="display:flex; gap:8px; justify-content:flex-end">
              <button class="btn" id="clearReflections">Clear</button>
              <button class="btn primary" id="addReflection">Add entry</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Mentor feedback</h2>
          <div id="feedback"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">¬© 2026 Minerva School ¬∑ Prototype for research &amp; co‚Äëdesign.</div>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Modal -->
  <dialog id="modal" style="border:none; border-radius:16px; padding:0; box-shadow:var(--shadow); width:min(720px, 90vw)">
    <div class="card" style="border:none; border-radius:16px">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3 id="modalTitle">Preview</h3>
        <form method="dialog"><button class="btn">Close</button></form>
      </div>
      <div id="modalBody" style="margin-top:6px"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px" id="modalActions"></div>
    </div>
  </dialog>

  <script>
    // --- Data (mock) ---
    const GRADES = ["K","1","2","3","4","5","6","7","8","9","10","11","12"];

    const LESSONS = [
      { id:"l1", title:"Foundations of Climate", subject:"Science", mode:"Self‚Äëpaced", grades:[6,7,8,9], band:"6-9" },
      { id:"l2", title:"Metacognition 101", subject:"Life Skills", mode:"Guided", grades:[5,6,7,8,9,10], band:"5-10" },
      { id:"l3", title:"Community Project", subject:"Social Studies", mode:"Collaborative", grades:[7,8,9,10,11,12], band:"7-12" },
      { id:"l4", title:"Fractions with Minecraft", subject:"Math", mode:"Guided", grades:[3,4,5], band:"3-5" },
      { id:"l5", title:"Narrative Writing", subject:"English", mode:"Self‚Äëpaced", grades:[6,7], band:"6-7" },
      { id:"l6", title:"Scratch: Arcade Games", subject:"Computer Science", mode:"Self‚Äëpaced", grades:[4,5,6], band:"4-6" },
      { id:"l7", title:"Watercolor Basics", subject:"Arts", mode:"Studio", grades:[6,7,8], band:"6-8" },
      { id:"l8", title:"Fitness Circuits", subject:"PE", mode:"Coach‚Äëled", grades:[9,10,11,12], band:"9-12" },
    ];

    const PEERS = [
      { id:"p1", name:"A. Singh", role:"Learner", interests:["Robotics","Climate"], grade:8 },
      { id:"p2", name:"R. Das", role:"Learner", interests:["Art","Debate"], grade:9 },
      { id:"p3", name:"Mentor Dev", role:"Mentor", interests:["Robotics","SDG 13"], grade:null },
      { id:"p4", name:"Ms. Gupta", role:"Teacher", interests:["Debate","Climate"], grade:null },
      { id:"p5", name:"K. Rao", role:"Learner", interests:["Sports","Climate"], grade:6 },
    ];

    // Broader, realistic projects (diverse themes)
    const PROJECTS = [
      { id:"pr1", title:"Clean Air Monitor", theme:"STEM", band:"6-8",
        blurb:"Prototype low‚Äëcost air‚Äëquality sensors and map hotspots around school.",
        skills:["Design","Data","IoT"] },

      { id:"pr2", title:"Wellness Ambassadors", theme:"Wellbeing", band:"9-12",
        blurb:"Peer‚Äëled campaign to improve sleep, movement, and nutrition.",
        skills:["Leadership","Communication"] },

      { id:"pr3", title:"Local Heritage Oral History", theme:"Arts & Culture", band:"6-8",
        blurb:"Interview elders, digitize photographs, and produce a mini‚Äëdocumentary.",
        skills:["Research","Media","Curation"] },

      { id:"pr4", title:"Math Trails Around Campus", theme:"STEM", band:"3-5",
        blurb:"Design outdoor math tasks‚Äîarea, angles, ratios‚Äîthen guide younger classes.",
        skills:["Problem design","Facilitation"] },

      { id:"pr5", title:"Assistive Tech: Switch Interface", theme:"Entrepreneurship", band:"9-12",
        blurb:"Build a low‚Äëcost switch interface for accessible computer input.",
        skills:["Electronics","UX","Prototyping"] },

      { id:"pr6", title:"School Garden Hydroponics", theme:"Community & Service", band:"6-8",
        blurb:"Grow herbs in a small hydroponic rig; run a tasting day for families.",
        skills:["Biology","Iteration","Data"] },

      { id:"pr7", title:"AI Literacy Buddies", theme:"Media & Communication", band:"9-12",
        blurb:"Create short explainers and a ‚Äúdo/don‚Äôt‚Äù AI usage guide for middle school.",
        skills:["Instructional design","Ethics","Comms"] },

      { id:"pr8", title:"Book‚Äëto‚ÄëFilm Festival", theme:"Arts & Culture", band:"3-5",
        blurb:"Adapt favorite chapters into 2‚Äëminute films; storyboards, voice‚Äëover, credits.",
        skills:["Storytelling","Editing"] }
    ];

    // --- Utility ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const toast = (msg)=>{ const t = $('#toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); };
    const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const load = (k, d=null)=>JSON.parse(localStorage.getItem(k) || (d!==null?JSON.stringify(d):'null'));

    // Theme toggle: flips a class on <html> to invert the media preference
    const themeBtn = $('#themeBtn');
    themeBtn?.addEventListener('click', ()=>{
      const html = document.documentElement;
      html.classList.toggle('force-dark');
      if(html.classList.contains('force-dark')){
        html.style.colorScheme = 'dark';
        html.style.setProperty('--surface', '#0d0b13');
        html.style.setProperty('--card', '#151221DD');
        html.style.setProperty('--ink', '#e5e7eb');
        html.style.setProperty('--muted', '#94a3b8');
        html.style.setProperty('--ring', '#3b2b66');
      }else{
        html.style.colorScheme = 'light';
        html.style.removeProperty('--surface');
        html.style.removeProperty('--card');
        html.style.removeProperty('--ink');
        html.style.removeProperty('--muted');
        html.style.removeProperty('--ring');
      }
    });

    // --- Routing ---
    const routes = $$("[data-route]").map(s=>s.id);
    function go(hash){
      const target = hash.replace('#','') || 'join';
      $$("nav a[data-link]").forEach(a=>a.classList.toggle('active', a.getAttribute('href') === '#'+target));
      routes.forEach(id => $('#'+id).classList.toggle('hidden', id!==target));
      if(target==='dashboard') refreshDashboard();
      if(target==='lessons') renderLessons();
      if(target==='peers') renderPeers();
      if(target==='projects') renderProjects();
      $('#logoutBtn').classList.toggle('hidden', !load('minerva_current_user'));
    }
    window.addEventListener('hashchange', ()=>go(location.hash));

    // --- Auth ---
    function currentUser(){ return load('minerva_current_user'); }
    function users(){ return load('minerva_users', []); }

    $('#joinForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const u = {
        id: 'u_'+Date.now(),
        firstName: $('#firstName').value.trim(),
        lastName: $('#lastName').value.trim(),
        role: $('#role').value,
        email: $('#email').value.trim().toLowerCase(),
        pw: $('#pw').value
      };
      const all = users();
      if(all.some(x=>x.email===u.email)) return toast('This email is already registered.');
      all.push(u); save('minerva_users', all); save('minerva_current_user', {id:u.id, name:u.firstName});
      toast('Welcome '+u.firstName+'! Account created.');
      location.hash = '#dashboard';
    });

    $('#loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = $('#loginEmail').value.trim().toLowerCase();
      const pw = $('#loginPw').value;
      const u = users().find(x=>x.email===email && x.pw===pw);
      if(!u) return toast('Invalid credentials');
      save('minerva_current_user', {id:u.id, name:u.firstName});
      toast('Signed in');
      location.hash = '#dashboard';
    });
    $('#showPw').addEventListener('change', (e)=>{ $('#loginPw').type = e.target.checked? 'text':'password'; });
    $('#forgotBtn').addEventListener('click', () => toast('Password reset is mocked for the prototype.'));
    $('#logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('minerva_current_user'); toast('Signed out'); location.hash = '#login'; });

    // --- Lessons page ---
    function initGrades(){
      const sel = $('#gradeSelect'); sel.innerHTML='';
      GRADES.forEach((g,i)=>{
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = g==='K'? 'K': g; sel.appendChild(opt);
      });
      sel.value = 6; // default to Grade 6
      sel.addEventListener('change', renderLessons);
      $$('.subFilter').forEach(cb=>cb.addEventListener('change', renderLessons));
    }

    function renderLessons(){
      const gradeIdx = +$('#gradeSelect').value; // 0..12
      const selectedSubs = $$('.subFilter').filter(cb=>cb.checked).map(cb=>cb.value);
      const tbody = $('#lessonsBody'); tbody.innerHTML='';
      LESSONS.filter(l => l.grades.includes(gradeIdx) && selectedSubs.includes(l.subject))
        .forEach(l => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${l.title}</td><td>${l.subject}</td><td>${l.mode}</td><td>${l.band}</td>
                          <td><button class='btn' data-open='${l.id}'>Open</button></td>`;
          tbody.appendChild(tr);
        });
      tbody.querySelectorAll('button[data-open]').forEach(btn=>btn.addEventListener('click', ()=>openLesson(btn.dataset.open)));
      if(!tbody.children.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5">No lessons for the selected filters.</td>`;
        tbody.appendChild(tr);
      }
    }

    function openLesson(id){
      const l = LESSONS.find(x=>x.id===id);
      $('#modalTitle').textContent = l.title;
      $('#modalBody').innerHTML = `<p><strong>Subject:</strong> ${l.subject} ¬∑ <strong>Mode:</strong> ${l.mode} ¬∑ <strong>Grade band:</strong> ${l.band}</p>
        <ol>
          <li>Warm‚Äëup (5 min)</li>
          <li>Explore: interactive activity</li>
          <li>Reflect &amp; share</li>
        </ol>`;
      const actions = $('#modalActions');
      actions.innerHTML = '';
      const start = document.createElement('button'); start.className='btn primary'; start.textContent='Start lesson';
      start.addEventListener('click', ()=>{
        const prog = load('minerva_progress', {});
        prog[id] = Math.min(100, (prog[id]||0) + 20);
        save('minerva_progress', prog);
        toast('Progress saved');
        refreshDashboard();
      });
      const saveToDash = document.createElement('button'); saveToDash.className='btn'; saveToDash.textContent='Pin to dashboard';
      saveToDash.addEventListener('click', ()=>{
        const up = load('minerva_upcoming', []); if(!up.includes(l.title)) up.push(l.title); save('minerva_upcoming', up); refreshDashboard(); toast('Pinned to Upcoming');
      });
      actions.append(saveToDash, start);
      $('#modal').showModal();
    }

    // --- Peers ---
    let currentPeer = null;
    function renderPeers(){
      const list = $('#peerList'); list.innerHTML='';
      const roleSel = $('#roleFilter').value;
      const interests = $$('.interest').filter(i=>i.checked).map(i=>i.value);
      PEERS.filter(p => (roleSel==='All' || p.role===roleSel) && (interests.length===0 || p.interests.some(i=>interests.includes(i))))
           .forEach(p => {
             const card = document.createElement('div'); card.className='card'; card.style.padding='12px';
             card.innerHTML = `<div style='display:flex; justify-content:space-between; align-items:center'>
               <div><strong>${p.name}</strong><div style='color:var(--muted); font-size:13px'>${p.role}${p.grade? ' ¬∑ G'+p.grade:''}</div></div>
               <button class='btn' data-connect='${p.id}'>Connect</button></div>
               <div style='margin-top:8px; display:flex; gap:6px; flex-wrap:wrap'>${p.interests.map(i=>`<span class='pill'>${i}</span>`).join('')}</div>`;
             list.appendChild(card);
           });
      $('#roleFilter').onchange = renderPeers;
      $$('.interest').forEach(i=>i.onchange = renderPeers);
      list.querySelectorAll('[data-connect]').forEach(btn=>btn.addEventListener('click', ()=>openChat(btn.dataset.connect)));
      if(!currentPeer && PEERS[0]) openChat(PEERS[0].id);
    }

    function openChat(peerId){
      currentPeer = PEERS.find(p=>p.id===peerId);
      $('#chatMessages').innerHTML = (load('chat_'+peerId, [])).map(m=>`<div class='bubble ${m.me? 'me':''}'>${m.text}</div>`).join('');
      toast('Chatting with '+currentPeer.name);
    }
    $('#sendMsg').addEventListener('click', ()=>{
      if(!currentPeer) return;
      const input = $('#chatInput'); const text = input.value.trim(); if(!text) return;
      const msgs = load('chat_'+currentPeer.id, []); msgs.push({me:true, text}); save('chat_'+currentPeer.id, msgs);
      $('#chatMessages').insertAdjacentHTML('beforeend', `<div class='bubble me'>${text}</div>`);
      input.value='';
      // bot auto‚Äëreply (mock)
      setTimeout(()=>{
        const reply = {me:false, text:'üëç Let\'s collaborate on it.'};
        const msgs2 = load('chat_'+currentPeer.id, []); msgs2.push(reply); save('chat_'+currentPeer.id, msgs2);
        $('#chatMessages').insertAdjacentHTML('beforeend', `<div class='bubble'>${reply.text}</div>`);
      }, 600);
    });

    // --- Projects ---
    function renderProjects(){
      const grid = $('#projectGrid'); grid.innerHTML='';
      const theme = $('#projTheme').value; const band = $('#projGrade').value;
      PROJECTS.filter(p => (theme==='All'||p.theme===theme) && (band==='All'||p.band===band))
        .forEach(p =>{
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `<h3>${p.title}</h3>
            <div style='color:var(--muted); font-size:14px; margin-top:-6px'>${p.theme} ¬∑ ${p.band}</div>
            <p>${p.blurb}</p>
            <div style='display:flex; gap:6px; flex-wrap:wrap; margin-top:6px'>${p.skills.map(s=>`<span class='pill'>${s}</span>`).join('')}</div>
            <div style='display:flex; gap:8px; justify-content:flex-end; margin-top:10px'>
              <button class='btn' data-preview='${p.id}'>Preview</button>
              <button class='btn primary' data-join='${p.id}'>Join project</button>
            </div>`;
          grid.appendChild(card);
        });
      $('#projTheme').onchange = renderProjects; $('#projGrade').onchange = renderProjects;
      grid.querySelectorAll('[data-preview]').forEach(btn=>btn.addEventListener('click', ()=>openProject(btn.dataset.preview)));
      grid.querySelectorAll('[data-join]').forEach(btn=>btn.addEventListener('click', ()=>joinProject(btn.dataset.join)));
    }

    function openProject(id){
      const p = PROJECTS.find(x=>x.id===id);
      $('#modalTitle').textContent = p.title;
      $('#modalBody').innerHTML = `<p>${p.blurb}</p><ul><li>Artifacts: proposal ‚Üí prototype ‚Üí showcase</li><li>Team size: 3‚Äì5</li><li>Duration: 4 weeks</li></ul>`;
      $('#modalActions').innerHTML = `<button class='btn primary' data-join='${p.id}'>Join project</button>`;
      $('#modal').showModal();
      $('#modalActions [data-join]').addEventListener('click', ()=>joinProject(p.id));
    }

    function joinProject(id){
      const my = load('my_projects', []); const p = PROJECTS.find(x=>x.id===id);
      if(!my.some(x=>x.id===id)) my.push(p); save('my_projects', my);
      const up = load('minerva_upcoming', []); if(!up.includes(p.title)) {up.push(p.title); save('minerva_upcoming', up);}
      toast('Added to your dashboard'); refreshDashboard();
    }

    // --- Dashboard ---
    function refreshDashboard(){
      const prog = load('minerva_progress', {});
      const subjects = {};
      LESSONS.forEach(l=>{ subjects[l.subject] = Math.max(subjects[l.subject]||0, prog[l.id]||0); });
      const list = $('#progressList'); list.innerHTML='';
      Object.entries(subjects).forEach(([sub, pct])=>{
        const row = document.createElement('div');
        row.innerHTML = `<div style='display:flex; justify-content:space-between; align-items:center; margin-bottom:6px'><strong>${sub}</strong><span>${pct||0}%</span></div><div class='progress'><span style='width:${pct||0}%'></span></div>`;
        list.appendChild(row);
      });
      if(!Object.keys(subjects).length){ list.innerHTML = '<div class="pill">No progress yet ‚Äî start a lesson to see updates.</div>'; }

      const upcoming = load('minerva_upcoming', []);
      const ul = $('#upcomingList'); ul.innerHTML='';
      upcoming.forEach(u=>{ const li=document.createElement('li'); li.textContent = u; ul.appendChild(li); });
      if(!upcoming.length){ ul.innerHTML = '<li>Add a lesson or join a project to populate Upcoming.</li>'; }

      const refl = load('reflections', []);
      const wrap = $('#reflections'); wrap.innerHTML = refl.map(r=>`<div class='card' style='padding:10px; margin:8px 0'><div style='font-size:13px; color:var(--muted)'>${new Date(r.t).toLocaleString()}</div>${r.text}</div>`).join('') || '<div class="pill">No reflections yet.</div>';

      const fb = [
        {from:'Mentor Dev', text:'Great systems mapping in your climate module. Next time, push for clearer measurements.'},
        {from:'Ms. Gupta', text:'Loved your reflection depth. Try a "plan‚Äëdo‚Äëreview" next week.'}
      ];
      $('#feedback').innerHTML = fb.map(f=>`<div class='card' style='padding:10px; margin:8px 0'><strong>${f.from}</strong><div>${f.text}</div></div>`).join('');
    }

    // --- Init ---
    initGrades();
    go(location.hash || '#join');

    // If the image fails to load, show the gradient fallback block
    const img = document.querySelector('img.logo');
    const fallbackBlock = document.querySelector('.brand .logo:not(img)');
    if(img){
      img.addEventListener('error', ()=> fallbackBlock.classList.remove('hidden'));
      img.addEventListener('load',  ()=> fallbackBlock.classList.add('hidden'));
    }
  </script>
</body>
</html>
